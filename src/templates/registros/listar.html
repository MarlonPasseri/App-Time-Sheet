{% extends 'base.html' %}

{% block title %}
    <title>Controle de Horas - Registros</title>
{% endblock %}

{% block main %}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Registros de Horas</h2>
        <div class="d-flex gap-2">
            <div class="btn-group" role="group">
                <input type="radio" class="btn-check" name="visualizacao" id="detalhado" autocomplete="off" checked>
                <label class="btn btn-outline-primary" for="detalhado">Detalhado</label>
                
                <input type="radio" class="btn-check" name="visualizacao" id="agregado" autocomplete="off">
                <label class="btn btn-outline-primary" for="agregado">Agregado Mensal</label>
            </div>
            <a href="{{ url_for('registros.adicionar') }}" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> Adicionar Registro
            </a>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Filtros</h5>
        </div>
        <div class="card-body">
            <form method="GET" action="{{ url_for('registros.listar') }}" class="row g-3">
                <div class="col-md-4">
                    <label for="funcionario_id" class="form-label">Colaborador</label>
                    <select class="form-select" id="funcionario_id" name="funcionario_id">
                        <option value="">Todos</option>
                        {% for funcionario in funcionarios %}
                            <option value="{{ funcionario.id }}" {% if filtro_funcionario_id == funcionario.id %}selected{% endif %}>
                                {{ funcionario.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="projeto_id" class="form-label">Contrato</label>
                    <select class="form-select" id="projeto_id" name="projeto_id">
                        <option value="">Todos</option>
                        {% for projeto in projetos %}
                            <option value="{{ projeto.id }}" {% if filtro_projeto_id == projeto.id %}selected{% endif %}>
                                {{ projeto.nome }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="mes_ano" class="form-label">Mês/Ano</label>
                    <input type="month" class="form-control" id="mes_ano" name="mes_ano" value="{{ filtro_mes_ano }}">
                </div>
                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-primary">Aplicar Filtros</button>
                    <a href="{{ url_for('registros.listar') }}" class="btn btn-secondary">Limpar Filtros</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card" id="tabela-detalhada">
        <div class="card-body">
            {% if registros %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <a href="?{{ request.query_string.decode() }}&ordenar=colaborador" class="text-decoration-none text-reset">
                                        Colaborador <i class="bi bi-arrow-down-up"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="?{{ request.query_string.decode() }}&ordenar=contrato" class="text-decoration-none text-reset">
                                        Contrato <i class="bi bi-arrow-down-up"></i>
                                    </a>
                                </th>
                                <th>
                                    <a href="?{{ request.query_string.decode() }}&ordenar=data" class="text-decoration-none text-reset">
                                        Data <i class="bi bi-arrow-down-up"></i>
                                    </a>
                                </th>
                                <th>Horas</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros %}
                                <tr>
                                    <td>{{ registro.funcionario }}</td>
                                    <td>{{ registro.projeto }}</td>
                                    <td>{{ registro.data | formatar_data }}</td>
                                    <td>{{ registro.horas_trabalhadas|formatar_horas }}</td>
                                    <td>
                                        <a href="{{ url_for('registros.editar', id=registro.id) }}" class="btn btn-sm btn-primary">
                                            Editar
                                        </a>
                                        <!-- <form action="{{ url_for('registros.remover', id=registro.id) }}" method="POST" class="d-inline"> -->
                                            <!-- <button type="submit" class="btn btn-sm btn-danger btn-delete">
                                                Excluir
                                            </button> -->
                                            <button r-id="{{ registro.id }}" r-func="{{ registro.funcionario }}" r-proj="{{ registro.projeto }}" r-data="{{ registro.data }}" r-horas="{{ registro.horas_trabalhadas|formatar_horas }}" class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#modalConfirmarExcluir">
                                                Excluir
                                            </button>
                                        <!-- </form> -->
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td colspan="3"><strong>Total de Horas:</strong></td>
                                <td><strong>{{ total_horas|formatar_horas }}</strong></td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    Nenhum registro encontrado. <a href="{{ url_for('registros.adicionar') }}">Adicionar um registro</a>.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Tabela Agregada (inicialmente oculta) -->
    <div class="card" id="tabela-agregada" style="display: none;">
        <div class="card-body">
            {% if registros_agregados %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Colaborador</th>
                                <th>Contrato</th>
                                <th>Mês/Ano</th>
                                <th>Total de Horas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registro in registros_agregados %}
                                <tr>
                                    <td>{{ registro.colaborador }}</td>
                                    <td>{{ registro.contrato }}</td>
                                    <td>{{ registro.mes_ano }}</td>
                                    <td>{{ registro.total_horas|formatar_horas }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="table-info">
                                <td colspan="3"><strong>Total Geral:</strong></td>
                                <td><strong>{{ total_horas_agregado|formatar_horas }}</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    Nenhum registro encontrado para agregação.
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        // Script para alternar entre visualização detalhada e agregada
        document.addEventListener('DOMContentLoaded', function() {
            const detalhadoRadio = document.getElementById('detalhado');
            const agregadoRadio = document.getElementById('agregado');
            const tabelaDetalhada = document.getElementById('tabela-detalhada');
            const tabelaAgregada = document.getElementById('tabela-agregada');
            
            function alternarVisualizacao() {
                if (detalhadoRadio.checked) {
                    tabelaDetalhada.style.display = 'block';
                    tabelaAgregada.style.display = 'none';
                } else if (agregadoRadio.checked) {
                    tabelaDetalhada.style.display = 'none';
                    tabelaAgregada.style.display = 'block';
                }
            }
            
            detalhadoRadio.addEventListener('change', alternarVisualizacao);
            agregadoRadio.addEventListener('change', alternarVisualizacao);
            
            // Inicializar com visualização detalhada
            alternarVisualizacao();
        });
    </script>

    <!-- Modal Excluir Registro -->
    <div class="modal fade" id="modalConfirmarExcluir" tabindex="-1" aria-labelledby="modalConfirmarExcluirLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalConfirmarExcluirLabel">Tem certeza que deseja excluir este registro?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Colaborador:
                        <span id="colaborador"></span>
                    </p>
                    <p>
                        Contrato:
                        <span id="contrato"></span>
                    </p>
                    <p>
                        Data:
                        <span id="data"></span>
                    </p>
                    <p>
                        Horas:
                        <span id="horas"></span>
                    </p>
                </div>
                <div class="modal-footer">
                    <form id="delete-form" method="POST" class="d-inline">
                        <button type="submit" class="btn btn-primary">Sim</button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modalExcluir = document.getElementById('modalConfirmarExcluir');

        const nomeSpan = document.getElementById('colaborador');
        const contratoSpan = document.getElementById('contrato');
        const dataSpan = document.getElementById('data');
        const horasSpan = document.getElementById('horas');

        const formExcluir = document.getElementById('delete-form');

        modalExcluir.addEventListener('show.bs.modal', event => {
            const button = event.relatedTarget; // botão que abriu o modal
            const id = button.getAttribute('r-id');
            const nome = button.getAttribute('r-func');
            const projeto = button.getAttribute('r-proj');
            const data = button.getAttribute('r-data');
            const horas = button.getAttribute('r-horas');

            // mostra as informações no modal
            nomeSpan.textContent = nome;
            contratoSpan.textContent = projeto;
            dataSpan.textContent = data;
            horasSpan.textContent = horas;

            // atualiza o action do form
            formExcluir.action = "{{ url_for('registros.remover', id=0) }}".replace("0", id);
        });
    </script>
{% endblock %}