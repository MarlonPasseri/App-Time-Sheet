{% extends 'base.html' %}

    {% block head %}
        <!-- CSS do Select2 -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <style>
            /* Container principal do select 2 */
            .select2-container .select2-selection--multiple {
                height: 3.5rem !important;
                padding: 0 !important;
                padding-left: 16px !important;
                border-radius: 0.5rem; /* rounded-lg */
                border: 1px solid #dbe2e6; /* sua classe border-gray-medium */
                background-color: white;

                position: relative;
                padding-right: 2rem !important; /* espaço para a seta */

                *{
                    margin: 0 !important;
                }
                :hover{
                    background-color: transparent !important;
                }
            }

            /* seta estilizada com CSS */
            .select2-container--default .select2-selection--multiple::after {
                content: "▾"; /* seta para baixo */
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 1.3rem;
                color: #6b7280; /* cinza */
                pointer-events: none; /* não bloquear clique */
            }

            .dark .select2-container .select2-selection--multiple {
                background-color: #1f2937 !important; /* dark:bg-gray-700 */
                border-color: #374151 !important;     /* dark:border-gray-600 */
                color: white !important;
            }

            /* Container de pesquisa */
            .select2-search--inline .select2-search__field {
                height: 3.5rem !important;
                line-height: 3.5rem !important;
                font-family: inherit !important;
            }

            /* Container de seleção de opção */
            .select2-selection__choice{
                line-height: 3.5rem !important;
                background-color: transparent !important;
                border: none !important;
            }

            /* Container de remoção de opção */
            .select2-selection__choice__remove{
                color: #ff0000 !important;
                font-weight: 900 !important;
                font-size: 20px !important;
                border: none !important;
            }

            /* Remoção do ícone de calendário padrão */
            input[type="month"]::-webkit-calendar-picker-indicator {
                opacity: 0;
            }
        </style>

    {% endblock %}

    {% block main %}
            <main class="flex-1 px-4 sm:px-10">
                <div class="layout-content-container flex flex-col max-w-5xl mx-auto flex-1">
                    <div class="flex flex-wrap justify-between gap-3">
                        <p class="text-text-primary dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">Registro de Horas</p>
                    </div>
                    <div class="bg-white dark:bg-background-dark/50 p-6 md:p-8 rounded-xl shadow-sm mt-6 border border-gray-light dark:border-gray-700">
                        <form method="POST" action="{{ url_for('registros.adicionar') }}" class="grid grid-cols-1 md:grid-cols-4 gap-x-8 gap-y-6">
                            <div class="{% if not admin_check %} md:col-span-4 {% else %} md:col-span-2 {% endif %}">
                                <label class="flex flex-col">
                                    <p class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Contrato</p>
                                    <select id="projeto_id" name="projeto_id" multiple required>
                                        <option></option>
                                        {% for projeto in projetos %}
                                            <option value="{{ projeto.id }}">{{ projeto.cod }} | {{ projeto.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                            </div>
                            {% if admin_check %}
                            <!-- Campo visível apenas para administradores -->
                            <div class="md:col-span-2">
                                <label for="funcionario_id" class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2" >Colaborador</label>
                                <select id="funcionario_id" name="funcionario_id" multiple required>
                                    <option></option>
                                    {% for funcionario in funcionarios %}
                                        <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% else %}
                            <!-- Apenas passa o ID do funcionário logado -->
                            <input type="hidden" name="funcionario_id" value="{{ funcionario_logado }}">
                            {% endif %}
                            <div class="md:col-span-2">
                                <label class="flex flex-col">
                                    <p class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Data</p>
                                    <div class="relative flex w-full flex-1 items-stretch rounded-lg">
                                        <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal cursor-pointer" id="data" name="data" max="{{ mes_atual }}" type="month" required/>
                                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-medium cursor-pointer">calendar_month</span>
                                    </div>
                                </label>
                            </div>
                            <div class="md:col-span-1" id="horasDiv">
                                <label class="flex flex-col">
                                    <p class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Horas</p>
                                    <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal" id="horas_trabalhadas" name="horas_trabalhadas" step="0.5" min="0.5" type="number" placeholder="ex.: 8.5 para 8h 30min" required/>
                                </label>
                            </div>
                            <div class="md:col-span-4 hidden" id="observacoesDiv">
                                <label class="flex flex-col">
                                    <p class="text-text-dark dark:text-gray-300 text-base font-medium leading-normal pb-2">Descrição da Atividade</p>
                                    <textarea id="observacoes" name="observacoes" class="form-textarea flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-text-dark dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark min-h-28 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal" placeholder="Descreva brevemente as atividades realizadas..." minlength="5" oninvalid="this.setCustomValidity('Digite pelo menos 5 caracteres')" oninput="this.setCustomValidity('')"></textarea>
                                </label>
                            </div>
                            <div class=" flex md:col-span-1 items-end" id="btnRegistroDiv">
                                <button type="submit" class="flex lex w-full min-w-0 flex-1 resize-none cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors justify-end">
                                    <span class="truncate">Registrar Horas</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-12">
                        <h3 class="text-2xl font-bold text-text-primary dark:text-white mb-4">Registros Recentes</h3>
                        <div class="overflow-x-auto bg-white dark:bg-background-dark/50 rounded-xl shadow-sm border border-gray-light dark:border-gray-700" id="registros-fragment">
                            <div class="bg-white dark:bg-background-dark/50 px-6 pb-4 shadow-sm mt-6">
                                <form method="GET" action="{{ url_for('registros.listar') }}" class="row g-3" id="form_filter">
                                    {% if admin_check %}
                                    <!-- Campo visível apenas para administradores -->
                                    <div class="col-md-4">
                                        <label for="funcionario_id_filter" class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Colaborador</label>
                                        <select id="funcionario_id_filter" name="funcionario_id_filter" multiple>
                                            <option></option>
                                            {% for funcionario in funcionarios %}
                                                <option value="{{ funcionario.id }}" {% if filtro_funcionario_id == funcionario.id %}selected{% endif %}>
                                                    {{ funcionario.nome }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    {% endif %}
                                    <div class="{% if admin_check %}col-md-4{% else %}col-md-6{% endif %}">
                                        <label for="projeto_id_filter" class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Contrato</label>
                                        <select id="projeto_id_filter" name="projeto_id_filter" multiple>
                                            <option></option>
                                            {% for projeto in projetos %}
                                                <option value="{{ projeto.id }}" {% if filtro_projeto_id == projeto.id %}selected{% endif %}>
                                                    {{ projeto.cod }} | {{ projeto.nome }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="{% if admin_check %}col-md-4{% else %}col-md-6{% endif %}">
                                        <label for="mes_ano_filter" class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Data</label>
                                        <div class="relative flex w-full flex-1 items-stretch rounded-lg">
                                            <input type="month" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal cursor-pointer" id="mes_ano_filter" name="mes_ano_filter" value="{{ filtro_mes_ano }}">
                                            <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-medium cursor-pointer">calendar_month</span>
                                        </div>
                                    </div>
                                    <div class="col-12 h-12 text-end">
                                        <!-- Botão Buscar -->
                                    <button 
                                        type="submit"
                                        class="inline-flex items-center justify-center px-4 min-w-24 h-full rounded-lg
                                            bg-gray-900 text-white text-sm font-medium
                                            hover:bg-gray-800 active:bg-gray-700
                                            dark:bg-gray-100 dark:text-gray-900 dark:hover:bg-gray-200
                                            transition-colors"
                                    >
                                        Buscar
                                    </button>

                                    <!-- Botão Limpar -->
                                    <a 
                                        href="{{ url_for('registros.listar') }}"
                                        class="inline-flex items-center justify-center px-4 min-w-24 h-full rounded-lg
                                            border border-gray-300 text-gray-700 bg-white text-sm font-medium
                                            hover:bg-gray-50 active:bg-gray-100
                                            dark:border-gray-600 dark:text-gray-200 dark:bg-gray-800
                                            dark:hover:bg-gray-700
                                            transition-colors"
                                    >
                                        Limpar
                                    </a>
                                    </div>
                                </form>
                            </div>

                            <table class="w-full text-left text-sm text-text-primary dark:text-gray-300">
                                <thead class="bg-gray-light dark:bg-background-dark/70 text-xs uppercase">
                                    <tr>
                                        <th class="px-6 py-3" scope="col">
                                            <a href="{{ url_for('registros.listar') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}ordenar=colaborador&direcao={% if ordenar == 'colaborador' and direcao == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none ajax-link">
                                                Colaborador <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
                                            </a>
                                        </th>

                                        <th class="px-6 py-3" scope="col">
                                            <a href="{{ url_for('registros.listar') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}ordenar=contrato&direcao={% if ordenar == 'contrato' and direcao == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none ajax-link">
                                                Contrato <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
                                            </a>
                                        </th>

                                        <th class="px-6 py-3" scope="col">
                                            <a href="{{ url_for('registros.listar') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}ordenar=data&direcao={% if ordenar == 'data' and direcao == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none ajax-link">
                                                Data <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
                                            </a>
                                        </th>
                                        <th class="px-6 py-3 text-center" scope="col">Horas</th>
                                        <th class="px-6 py-3 text-center" scope="col">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="lista-registros">
                                    {% if registros|length == 0 %}
                                        <tr>
                                            <td colspan="5" class="px-6 py-4 text-center text-gray-medium dark:text-gray-500">
                                                Nenhum registro encontrado.
                                            </td>
                                        </tr>
                                    {% endif %}
                                    {% for registro in registros %}
                                        <tr class="border-b border-gray-light dark:border-gray-700">
                                            <td class="px-6 py-4">{{ registro.funcionario }}</td>
                                            <td class="px-6 py-4">
                                                {{ registro.projeto }}
                                                {% if registro.observacoes %}
                                                    <span class="material-symbols-outlined text-sm align-middle">attach_file</span>
                                                {% endif %}
                                            </td>
                                            <td class="px-6 py-4 text-center">{{ registro.data }}</td>
                                            <td class="px-6 py-4 text-center">{{ registro.horas_trabalhadas | formatar_horas }}</td>
                                            <td class="px-6 py-4 text-center">
                                                <button class="btn-editar text-gray-500 dark:text-gray-400 hover:text-primary dark:hover:text-blue-400"
                                                type="button" data-bs-toggle="modal"
                                                data-bs-target="#modalEditar"
                                                data-id="{{ registro.id }}"
                                                data-func="{{ registro.funcionario_id }}"
                                                data-funcnome="{{ registro.funcionario }}"
                                                data-proj="{{ registro.projeto_id }}"
                                                data-data="{{ registro.data_input }}"
                                                data-horas="{{ registro.horas_trabalhadas }}"
                                                data-observacao="{{ registro.observacoes }}"
                                                >
                                                    <span class="material-symbols-outlined text-xl">edit</span>
                                                </button>
                                                <button type="button" class="btn-excluir text-gray-500 dark:text-gray-400 hover:text-red-500"
                                                data-bs-toggle="modal"
                                                data-bs-target="#modalExcluir"
                                                data-id="{{ registro.id }}"
                                                data-func="{{ registro.funcionario }}"
                                                data-projid="{{ registro.projeto_id }}"
                                                data-projnome="{{ registro.projeto }}"
                                                data-data="{{ registro.data_input }}"
                                                data-horas="{{ registro.horas_trabalhadas }}"
                                                data-observacao="{{ registro.observacoes }}"
                                                >
                                                    <span class="material-symbols-outlined text-xl">delete</span>
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-info bg-gray-100 dark:bg-background-dark/60">
                                        <td class="px-6 py-4 font-black" colspan="3">Total de Horas:</td>
                                        <td class="px-6 py-4 font-black text-center">{{ total_horas | formatar_horas }}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="flex justify-between items-center p-4">
                                <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px">
                                    {% if pagina > 1 %}
                                        <a href="?{{ query_string_pages }}&pagina={{ pagina - 1 }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 ajax-link">
                                            <span class="material-symbols-outlined text-base">chevron_left</span>
                                        </a>
                                    {% endif %}

                                    <!-- Quantidade máxima de botões -->
                                    {% set window = 5 %}

                                    <!-- Calcula primeira página do bloco -->
                                    {% set start = pagina - 2 %}
                                    {% if start < 1 %}
                                        {% set start = 1 %}
                                    {% endif %}

                                    <!-- Calcula última página do bloco -->
                                    {% set end = start + window - 1 %}
                                    {% if end > total_paginas %}
                                        {% set end = total_paginas %}
                                        {% set start = end - window + 1 %}
                                        {% if start < 1 %}
                                            {% set start = 1 %}
                                        {% endif %}
                                    {% endif %}

                                    <!-- Renderiza os botões da janela dinâmica -->
                                    {% for p in range(start, end + 1) %}
                                        <a href="?{{ query_string_pages }}&pagina={{ p }}"
                                        class="{% if p == pagina %}z-10 bg-primary/20 border-primary text-primary relative inline-flex items-center px-4 py-2 border text-sm font-medium{% else %}bg-white dark:bg-gray-800 border-gray-300 dark:border-gray-600 text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 relative inline-flex items-center px-4 py-2 border text-sm font-medium{% endif %} ajax-link">
                                            {{ p }}
                                        </a>
                                    {% endfor %}

                                    {% if pagina < total_paginas %}
                                        <a href="?{{ query_string_pages }}&pagina={{ pagina + 1 }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-sm font-medium text-gray-500 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 ajax-link">
                                            <span class="material-symbols-outlined text-base">chevron_right</span>
                                        </a>
                                    {% endif %}
                                </nav>
                                <div id="contador-resultados">
                                    <p class="text-sm text-gray-700 dark:text-gray-300 px-5 text-center">
                                        Mostrando
                                        <span class="font-medium" id="mostrando-de">{{ mostrando_inicio }}</span>
                                        a
                                        <span class="font-medium" id="mostrando-ate">{{ mostrando_fim }}</span>
                                        de
                                        <span class="font-medium" id="total-resultados">{{ total_resultados }}</span>
                                        resultados
                                    </p>
                                </div>

                                <form method="GET" id="form_pages" class="flex items-center gap-4">
                                    <!-- Mantém os filtros atuais -->
                                    {% for k, v in request.args.items() %}
                                        {% if k != 'registros_por_pagina' and k != 'pagina' %}
                                            <input type="hidden" name="{{ k }}" value="{{ v }}">
                                        {% endif %}
                                    {% endfor %}

                                    <label for="registros_por_pagina" class="w-full text-sm font-medium">Registros por página:</label>
                                    <select name="registros_por_pagina" id="registros_por_pagina" onchange="this.form.submit()" class="form-select flex w-full min-w-0 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal cursor-pointer">
                                        <option value="5" {% if registros_por_pagina == 5 %}selected{% endif %}>5</option>
                                        <option value="10" {% if registros_por_pagina == 10 %}selected{% endif %}>10</option>
                                        <option value="20" {% if registros_por_pagina == 20 %}selected{% endif %}>20</option>
                                        <option value="50" {% if registros_por_pagina == 50 %}selected{% endif %}>50</option>
                                    </select>
                                </form>
                            </div>
                        </div>
                    </div>
                    <div class="mt-10">
                        <div class="bg-white dark:bg-background-dark/50 p-6 md:p-8 rounded-xl shadow-sm border border-gray-light dark:border-gray-700">
                            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                                <div class="flex items-center gap-4">
                                    <span id="icone-finalizar-mes" class="flex h-12 w-12 items-center justify-center rounded-full bg-green-100 text-green-700 text-xl font-bold">
                                        M
                                    </span>
                                    <div>
                                        <p class="text-text-primary dark:text-white text-lg font-semibold">Finalizar mês</p>
                                        <p id="texto-finalizar-mes" class="text-sm text-gray-600 dark:text-gray-300">
                                            {{ usuario.nome }}
                                        </p>
                                    </div>
                                </div>
                                <button
                                    id="btn-finalizar-mes"
                                    type="button"
                                    data-usuario="{{ usuario.nome }}"
                                    class="flex items-center justify-center gap-2 rounded-lg h-12 px-6 bg-green-600 text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-green-500 transition-colors"
                                >
                                    <span class="material-symbols-outlined text-xl">task_alt</span>
                                    <span>Finalizar mês</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- Modal editar -->
            <div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered max-w-xl">
                    <div class="modal-content dark:bg-gray-800">

                    <div class="modal-header border-b dark:border-gray-700">
                        <h5 class="modal-title text-xl font-semibold">Editar Registro</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <form id="formEditar" method="POST" action="">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="block font-medium mb-1">Colaborador</label>
                                {% if admin_check %}
                                <select id="funcionario_id_edit" name="funcionario_id_edit" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" multiple required>
                                    <option></option>
                                    {% for funcionario in funcionarios %}
                                        <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="text" id="funcionario_id_lock" name="funcionario_id_lock" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" readonly>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label class="block font-medium mb-1">Contrato</label>
                                <select id="projeto_id_edit" name="projeto_id_edit" multiple required>
                                    <option></option>
                                    {% for projeto in projetos %}
                                        <option value="{{ projeto.id }}">
                                            {{ projeto.cod }} | {{ projeto.nome }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="block font-medium mb-1">Data</label>
                                <div class="relative flex w-full flex-1 items-stretch rounded-lg">
                                    <input type="month" id="data_edit" name="data_edit" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal cursor-pointer" max="{{ mes_atual }}" required>
                                    <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-medium cursor-pointer">calendar_month</span>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="block font-medium mb-1">Horas Trabalhadas</label>
                                <input type="number" id="horas_edit" name="horas_edit" class="w-full p-3 border rounded-lg dark:bg-gray-700 dark:border-gray-600" step="0.5" min="0.5" type="number" placeholder="ex.: 8.5 para 8h 30min" required>
                            </div>

                            <div class="mb-3 hidden" id="observacoesDivEditar">
                                <label class="flex flex-col">
                                    <label class="block font-medium mb-1">Descrição da Atividade</label>
                                    <textarea id="observacoes_edit" name="observacoes_edit" class="form-textarea flex w-full min-w-0 flex-1 resize-y overflow-hidden rounded-lg text-text-dark dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark min-h-28 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal" placeholder="Descreva brevemente as atividades realizadas..." minlength="5" oninvalid="this.setCustomValidity('Digite pelo menos 5 caracteres')" oninput="this.setCustomValidity('')"></textarea>
                                </label>
                            </div>

                        </div>

                        <div class="modal-footer border-t dark:border-gray-700">
                        <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg"
                                data-bs-dismiss="modal">
                            Cancelar
                        </button>

                        <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/80">
                            Salvar
                        </button>
                        </div>
                    </form>

                    </div>
                </div>
            </div>

            <!-- Modal excluir -->
            <div class="modal fade" id="modalExcluir" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered max-w-xl">
                    <div class="modal-content dark:bg-gray-800">

                    <div class="modal-header border-b dark:border-gray-700">
                        <h5 class="modal-title text-xl font-semibold">Confirmar Remoção do Registro</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <form id="formExcluir" method="POST" action="">
                        <div class="modal-body space-y-4">

                            <!-- Colaborador -->
                            <div class="bg-gray-50 dark:bg-gray-700/40 border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                                <label for="funcionario_del" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
                                    Colaborador
                                </label>
                                <span
                                    id="funcionario_del"
                                    name="funcionario_del"
                                    class="block text-sm font-medium text-gray-900 dark:text-white"
                                ></span>
                            </div>

                            <!-- Contrato -->
                            <div class="bg-gray-50 dark:bg-gray-700/40 border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                                <label for="projeto_del" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
                                    Contrato
                                </label>
                                <span
                                    id="projeto_del"
                                    name="projeto_del"
                                    class="block text-sm font-medium text-gray-900 dark:text-white"
                                ></span>
                            </div>

                            <!-- Data -->
                            <div class="bg-gray-50 dark:bg-gray-700/40 border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                                <div class="flex items-center justify-between mb-1">
                                    <label for="data_del" class="block text-sm font-semibold text-gray-700 dark:text-gray-200">
                                        Data
                                    </label>
                                </div>
                                <span
                                    id="data_del"
                                    name="data_del"
                                    class="block text-sm font-medium text-gray-900 dark:text-white"
                                ></span>
                            </div>

                            <!-- Horas Trabalhadas -->
                            <div class="bg-gray-50 dark:bg-gray-700/40 border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                                <label for="horas_del" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
                                    Horas Trabalhadas
                                </label>
                                <span
                                    id="horas_del"
                                    name="horas_del"
                                    class="block text-sm font-medium text-gray-900 dark:text-white"
                                ></span>
                            </div>

                            <!-- Descrição da Atividade (opcional / escondido) -->
                            <div class="mb-3 hidden" id="observacoesDivExcluir">
                                <div class="bg-gray-50 dark:bg-gray-700/40 border border-gray-200 dark:border-gray-600 rounded-lg p-3">
                                    <label for="observacoes_del" class="block text-sm font-semibold text-gray-700 dark:text-gray-200 mb-1">
                                        Descrição da Atividade
                                    </label>
                                    <p
                                        id="observacoes_del"
                                        name="observacoes_del"
                                        class="text-sm text-gray-900 dark:text-white whitespace-pre-line"
                                    ></p>
                                </div>
                            </div>

                        </div>


                        <div class="modal-footer border-t dark:border-gray-700">
                        <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded-lg"
                                data-bs-dismiss="modal">
                            Cancelar
                        </button>

                        <button type="submit" class="px-4 py-2 bg-error text-white rounded-lg hover:bg-error/80">
                            Remover
                        </button>
                        </div>
                    </form>

                    </div>
                </div>
            </div>

    {% endblock %}
    {% block script %}
        <!-- jQuery e JS do Select2 -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        
        <!-- Configurações padrões -->
        <script>
            regrasSelect2Colaborador = {
                placeholder: "Selecione um colaborador",
                width: '100%',
                maximumSelectionLength: 1,   // limita a 1 item
                language: {
                    maximumSelected: function () {
                        return "Você só pode selecionar um item.";
                    },
                    noResults: function () {
                        return "Nenhum colaborador encontrado";
                    }
                }
            };

            regrasSelect2Contrato = {
                placeholder: "Selecione um contrato",
                width: '100%',
                maximumSelectionLength: 1,   // limita a 1 item
                language: {
                    maximumSelected: function () {
                        return "Você só pode selecionar um item.";
                    },
                    noResults: function () {
                        return "Nenhum contrato encontrado";
                    }
                }
            };

            // IDs dos projetos que mostram o campo de observações
            const projetosEspeciais = [1, 2, 3]; 
        </script>

        <!-- Selects 2 -->
        <script>
            $(document).ready(function() {
                $('#funcionario_id').select2(regrasSelect2Colaborador);
                $('#funcionario_id_filter').select2(regrasSelect2Colaborador);
                // $('#funcionario_id_edit').select2(regrasSelect2Colaborador);

                $('#projeto_id').select2(regrasSelect2Contrato);
                $('#projeto_id_filter').select2(regrasSelect2Contrato);
                // $('#projeto_id_edit').select2(regrasSelect2Contrato);
            });
        </script>

        <!-- Seletor do input de data mês, tira o calendário e mostra no clique em qualquer área do input -->
        <script>
            const dataInput = document.getElementById("data");
            const dataInputFilter = document.getElementById("mes_ano_filter");
            let dataEdit = document.getElementById("data_edit");

            dataInput.addEventListener("click", () => {
                dataInput.showPicker(); // força abrir o seletor
            });

            dataInputFilter.addEventListener("click", () => {
                dataInputFilter.showPicker(); // força abrir o seletor
            });

            dataEdit.addEventListener("click", () => {
                dataEdit.showPicker(); // força abrir o seletor
            });
        </script>

        <!-- Botão finalizar mês -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const botaoFinalizar = document.getElementById("btn-finalizar-mes");
                const iconeFinalizar = document.getElementById("icone-finalizar-mes");
                const textoFinalizar = document.getElementById("texto-finalizar-mes");

                if (!botaoFinalizar || !iconeFinalizar || !textoFinalizar) {
                    return;
                }

                const meses = [
                    "Janeiro",
                    "Fevereiro",
                    "Março",
                    "Abril",
                    "Maio",
                    "Junho",
                    "Julho",
                    "Agosto",
                    "Setembro",
                    "Outubro",
                    "Novembro",
                    "Dezembro"
                ];

                const obterMesSelecionado = () => {
                    const valor = dataInput?.value || "";
                    if (!valor) {
                        return new Date();
                    }
                    const [ano, mes] = valor.split("-");
                    return new Date(Number(ano), Number(mes) - 1, 1);
                };

                const atualizarIconeMes = () => {
                    const dataSelecionada = obterMesSelecionado();
                    const nomeMes = meses[dataSelecionada.getMonth()] || "Mês";
                    const inicialMes = nomeMes.charAt(0).toUpperCase();
                    const nomeUsuario = botaoFinalizar.dataset.usuario || "";

                    iconeFinalizar.textContent = inicialMes;
                    textoFinalizar.textContent = `${nomeMes} • ${nomeUsuario}`.trim();
                    botaoFinalizar.setAttribute(
                        "aria-label",
                        `Finalizar mês de ${nomeMes} para ${nomeUsuario}`.trim()
                    );
                };

                botaoFinalizar.addEventListener("click", atualizarIconeMes);
                atualizarIconeMes();
            });
        </script>

        <!-- Input de observações -->
        <script>
            document.addEventListener("DOMContentLoaded", () => {
                const observacoesDiv = document.getElementById('observacoesDiv');
                const horasDiv = document.getElementById('horasDiv');
                const btnRegistroDiv = document.getElementById('btnRegistroDiv');

                // Usando jQuery/Select2
                $('#projeto_id').on('change', function () {
                    const valor = $(this).val(); // sempre string ou array de strings

                    // Select2 com multiple = true sempre retorna array
                    // Mesmo que só 1 seja escolhido
                    const id = Number(valor?.[0]);

                    if (projetosEspeciais.includes(id)) {

                        const observacoes = document.getElementById("observacoes")

                        // Div de observações aparece
                        observacoesDiv.classList.remove('hidden');
                        observacoes.setAttribute("required", true)

                        // ajusta o grid da div de horas para ocupar 2 colunas
                        horasDiv.classList.remove("md:col-span-1");
                        horasDiv.classList.add("md:col-span-2");

                        // move o botão de registro para a quarta coluna
                        btnRegistroDiv.classList.remove("md:col-span-1");
                        btnRegistroDiv.classList.add("md:col-start-4");
                    } else {
                        observacoesDiv.classList.add('hidden');
                        observacoes.removeAttribute("required")

                        // div horas div volta ao normal
                        horasDiv.classList.remove("md:col-span-2");
                        horasDiv.classList.add("md:col-span-1");

                        // move o botão para a posição inicial
                        btnRegistroDiv.classList.remove("md:col-span-4");
                        btnRegistroDiv.classList.add("md:col-span-1");
                    }
                });
            });
        </script>



        <!-- AJAX para não recarregar a página na mudança de renderização da tabela por paginação ou ordenação -->
        <script>
            (function () {
            // Seletor do bloco que será atualizado
            const targetSelector = '#registros-fragment';

            // Função principal que busca a URL e injeta o tbody novo
            async function carregarFragmento(url, pushUrl = true) {
                try {
                const resp = await fetch(url, { credentials: 'same-origin' });
                if (!resp.ok) throw new Error('Erro na requisição: ' + resp.status);

                const html = await resp.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');

                // pega o fragmento do servidor
                const novoFragmento = doc.querySelector(targetSelector);
                if (!novoFragmento) {
                    console.warn('Fragmento não encontrado na resposta. Verifique se o servidor retorna #lista-registros no HTML.');
                    return;
                }

                // substitui o conteúdo
                const alvo = document.querySelector(targetSelector);
                if (!alvo) {
                    console.warn('Elemento alvo não encontrado no DOM:', targetSelector);
                    return;
                }
                alvo.innerHTML = novoFragmento.innerHTML;

                // atualiza a url no navegador sem recarregar (mantém histórico)
                if (pushUrl) {
                    history.pushState({}, '', url);
                }

                // opcional: você pode re-executar código que precisa rodar após atualização
                // ex: re-inicializar tooltips, select2, etc.
                function initAfterAjax() {
                // inicializar select2 novamente
                $('#funcionario_id_filter').select2(regrasSelect2Colaborador);

                $('#projeto_id_filter').select2(regrasSelect2Contrato);

                } initAfterAjax();

                } catch (err) {
                console.error('Erro ao carregar fragmento via AJAX:', err);
                }
            }

            // Delegation: intercepta todos os cliques em links com .ajax-link
            document.addEventListener('click', function (ev) {
                const a = ev.target.closest('a.ajax-link');
                if (!a) return;
                const href = a.getAttribute('href');
                if (!href) return;
                // ignora links externos
                const sameOrigin = new URL(href, location.href).origin === location.origin;
                if (!sameOrigin) return;

                ev.preventDefault();
                carregarFragmento(href, true);
            });

            // Tratamento de navegação do browser (back/forward)
            window.addEventListener('popstate', function () {
                // quando o usuário clica em voltar/avançar, carrega a URL atual
                carregarFragmento(location.href, false);
            });

            // Se você tem um form de filtros que usa GET, intercepta submit e usa fetch:
            const filtroForm = document.getElementById('form_filter'); // ajuste id se diferente
            if (filtroForm) {
                filtroForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const params = new URLSearchParams(new FormData(filtroForm)).toString();
                const url = location.pathname + (params ? '?' + params : '');
                carregarFragmento(url, true);
                });

                // opcional: interceptar onchange para submits automáticos
                filtroForm.addEventListener('change', function () {
                // se quiser enviar on change, descomente:
                // e.preventDefault();
                // const params = new URLSearchParams(new FormData(filtroForm)).toString();
                // carregarFragmento(location.pathname + (params ? '?' + params : ''), true);
                });
            }
            })();
        </script>

        <!-- Modal editar -->
        <script>
            const modalEditar = document.getElementById('modalEditar');
            const formEditar = document.getElementById('formEditar');

            const observacoesDivEditar = document.getElementById('observacoesDivEditar');
            const observacoesEdit = document.getElementById('observacoes_edit');
            dataEdit = document.getElementById('data_edit');
            const horasEdit = document.getElementById('horas_edit');
            const funcionarioLock = document.getElementById('funcionario_id_lock');

            const $funcionarioSelect = $('#funcionario_id_edit');
            const $projetoSelect = $('#projeto_id_edit');

            // 1) Inicializa Select2 UMA vez só
            $funcionarioSelect.select2({
                ...regrasSelect2Colaborador,
                dropdownParent: $('#modalEditar')
            });

            $projetoSelect.select2({
                ...regrasSelect2Contrato,
                dropdownParent: $('#modalEditar')
            });

            // 2) Função helper para lidar com observações
            function atualizarObservacoes(contratoId, observacaoOriginal) {
                const idNum = Number(contratoId);

                if (projetosEspeciais.includes(idNum)) {
                    // Mostra o campo
                    observacoesDivEditar.classList.remove('hidden');
                    observacoesEdit.setAttribute('required', 'required');

                    // Se veio algo do backend, mantemos. Se não, deixa o valor atual
                    if (observacaoOriginal && observacaoOriginal !== 'None') {
                        // Só sobrescreve se o campo estiver vazio,
                        // assim não apagamos algo que o usuário digitou após mudar o select
                        if (!observacoesEdit.value) {
                            observacoesEdit.value = observacaoOriginal;
                        }
                    }
                } else {
                    // Esconde e limpa para enviar "" para o backend
                    observacoesDivEditar.classList.add('hidden');
                    observacoesEdit.removeAttribute('required');
                    observacoesEdit.value = "";
                }
            }

            // 3) Delegação de clique nos botões "editar"
            document.addEventListener('click', function (event) {
                const button = event.target.closest('.btn-editar');
                if (!button) return;

                const id = button.dataset.id;
                const colaborador = button.dataset.func;
                const colaboradorNome = button.dataset.funcnome;
                const contrato = button.dataset.proj;
                const data = button.dataset.data;
                const horas = button.dataset.horas;
                const observacaoOriginal = button.dataset.observacao || "";

                // Preenche selects
                $funcionarioSelect.val(colaborador).trigger('change');
                $projetoSelect.val(contrato).trigger('change');

                // Preenche campos simples
                dataEdit.value = data;
                horasEdit.value = horas;
                observacoesEdit.value = observacaoOriginal !== "None" ? observacaoOriginal : "";

                if (funcionarioLock) {
                    funcionarioLock.value = colaboradorNome;
                }

                // Ajusta visibilidade / obrigatoriedade das observações com o contrato atual
                atualizarObservacoes(contrato, observacaoOriginal);

                // 4) Handler de mudança do projeto (sempre limpando o antigo antes)
                $projetoSelect.off('change.modaleditar').on('change.modaleditar', function () {
                    let valor = $(this).val();

                    // Se for select2 multiple, vem array; se não, vem string
                    if (Array.isArray(valor)) {
                        valor = valor[0];
                    }

                    atualizarObservacoes(valor, observacaoOriginal);
                });

                // Atualiza o action do form
                formEditar.action = "{{ url_for('registros.editar', id=0) }}".replace('0', id);
            });
        </script>


        <!-- Modal excluir -->
        <script>            
            // Delegation: escuta em document
            document.addEventListener('click', function(event) {
                const button = event.target.closest('.btn-excluir');
                if (!button) return;

                const id = button.dataset.id;
                const colaborador = button.dataset.func;
                const contrato_id = button.dataset.projid;
                const contrato = button.dataset.projnome;
                const data = button.dataset.data;
                const horas = button.dataset.horas;
                const observacao = button.dataset.observacao;

                document.getElementById('funcionario_del').innerHTML = colaborador;
                document.getElementById('projeto_del').innerHTML = contrato;
                document.getElementById('data_del').innerHTML = data.split("-").reverse().join("-");
                document.getElementById('horas_del').innerHTML = horas;
                document.getElementById('observacoes_del').innerHTML = observacao;

                const observacoesDivExcluir = document.getElementById('observacoesDivExcluir');
                if (projetosEspeciais.includes(Number(contrato_id))) {
                    // Div de observações aparece
                    observacoesDivExcluir.classList.remove('hidden');
                } else {
                    observacoesDivExcluir.classList.add('hidden');
                }

                // Atualiza o action do form
                document.getElementById('formExcluir').action = "{{ url_for('registros.remover', id=0) }}".replace('0', id);
            });

        </script>


    {% endblock %}
