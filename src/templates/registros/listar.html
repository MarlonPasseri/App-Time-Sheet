{% extends 'base.html' %}

    {% block head %}
        <!-- CSS do Select2 -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <style>
            /* Altura igual aos inputs h-14 (56px) */
            .select2-container .select2-selection--single {
                height: 3.5rem !important;
                display: flex !important;
                align-items: center !important;
                border-radius: 0.5rem; /* rounded-lg */
                border: 1px solid #dbe2e6; /* sua classe border-gray-medium */
                background-color: white;
            }

            .dark .select2-container .select2-selection--single {
                background-color: #1f2937 !important; /* dark:bg-gray-700 */
                border-color: #374151 !important;     /* dark:border-gray-600 */
                color: white !important;
            }

            .select2-container .select2-selection__rendered {
                font-size: 1rem !important;
                color: inherit !important;
            }

            /* Ícone da seta alinhado */
            .select2-container .select2-selection__arrow {
                height: 3.5rem !important;
                right: 10px !important;
            }

            .select2-container .select2-selection__clear{
                color: #ff0000 !important;
                margin: 0 !important;
                font-weight: 900 !important;
                font-size: 20px !important;
                padding-left: 1rem !important;
                padding-right: 8px !important;
            }

            .select2-container .select2-selection__placeholder {
                padding-left: 8px !important;
            }

            input[type="month"]::-webkit-calendar-picker-indicator {
                opacity: 0;
                /* padding-left: 2rem; */
                /* cursor: pointer; */
            }
        </style>

    {% endblock %}

    {% block main %}
            <main class="flex-1 px-4 sm:px-10">
                <div class="layout-content-container flex flex-col max-w-5xl mx-auto flex-1">
                    <div class="flex flex-wrap justify-between gap-3">
                        <p class="text-text-primary dark:text-white text-4xl font-black leading-tight tracking-[-0.033em] min-w-72">Registro de Horas</p>
                    </div>
                    <div class="bg-white dark:bg-background-dark/50 p-6 md:p-8 rounded-xl shadow-sm mt-6 border border-gray-light dark:border-gray-700">
                        <form method="POST" action="{{ url_for('registros.adicionar') }}" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                            <div class="{% if not admin_check %} md:col-span-2 {% endif %}">
                                <label class="flex flex-col">
                                    <p class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Projeto</p>
                                    <select class="form-select" id="projeto_id" name="projeto_id" required>
                                        <option value="">Selecione um projeto</option>
                                        {% for projeto in projetos %}
                                            <option value="{{ projeto.id }}">{{ projeto.id }} | {{ projeto.nome }}</option>
                                        {% endfor %}
                                    </select>
                                </label>
                            </div>
                            {% if admin_check %}
                            <!-- Campo visível apenas para administradores -->
                            <div>
                                <label for="funcionario_id" class="form-label" >Colaborador</label>
                                <select class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal appearance-none bg-no-repeat bg-right" id="funcionario_id" name="funcionario_id" required>
                                    <option value="">Selecione um colaborador</option>
                                    {% for funcionario in funcionarios %}
                                        <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% else %}
                            <!-- Apenas passa o ID do funcionário logado -->
                            <input type="hidden" name="funcionario_id" value="{{ funcionario_logado }}">
                            {% endif %}
                            <div>
                                <label class="flex flex-col">
                                    <p class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Data</p>
                                    <div class="relative flex w-full flex-1 items-stretch rounded-lg">
                                        <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal cursor-pointer" id="data" name="data" max="{{ mes_atual }}" type="month" required/>
                                        <span class="material-symbols-outlined absolute right-4 top-1/2 -translate-y-1/2 text-gray-medium cursor-pointer">calendar_month</span>
                                    </div>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-4 items-end">
                                <label class="flex flex-col">
                                    <p class="text-text-primary dark:text-gray-300 text-base font-medium leading-normal pb-2">Horas</p>
                                    <input class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal" id="horas_trabalhadas" name="horas_trabalhadas" step="0.5" min="0.5" type="number" placeholder="ex.: 8.5 para 8h 30min" required/>
                                </label>
                                <button type="submit" class="flex lex w-full min-w-0 flex-1 resize-none cursor-pointer items-center justify-center overflow-hidden rounded-lg h-14 px-6 bg-primary text-white text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-colors justify-end">
                                    <span class="truncate">Registrar Horas</span>
                                </button>
                            </div>
                        </form>
                    </div>
                    <div class="mt-12">
                        <h3 class="text-2xl font-bold text-text-primary dark:text-white mb-4">Registros Recentes</h3>
                        <div class="overflow-x-auto bg-white dark:bg-background-dark/50 rounded-xl shadow-sm border border-gray-light dark:border-gray-700">


                            <!-- Adicionar os filtros de busca, mudar os IDs para não conflitar com o form de adicionar registro e testar o link-->


                            <table class="w-full text-left text-sm text-text-primary dark:text-gray-300">
                                <thead class="bg-gray-light dark:bg-background-dark/70 text-xs uppercase">
                                    <tr>
                                        <th class="px-6 py-3" scope="col">
                                            <a href="{{ url_for('registros.listar') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}ordenar=colaborador&direcao={% if ordenar == 'colaborador' and direcao == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                                Colaborador <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
                                            </a>
                                        </th>

                                        <th class="px-6 py-3" scope="col">
                                            <a href="{{ url_for('registros.listar') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}ordenar=contrato&direcao={% if ordenar == 'contrato' and direcao == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                                Contrato <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
                                            </a>
                                        </th>

                                        <th class="px-6 py-3" scope="col">
                                            <a href="{{ url_for('registros.listar') }}{% if query_string %}?{{ query_string }}&{% else %}?{% endif %}ordenar=data&direcao={% if ordenar == 'data' and direcao == 'asc' %}desc{% else %}asc{% endif %}" class="text-decoration-none">
                                                Data <span class="material-symbols-outlined text-sm align-middle">swap_vert</span>
                                            </a>
                                        </th>
                                        <th class="px-6 py-3 text-center" scope="col">Horas</th>
                                        <th class="px-6 py-3 text-center" scope="col">Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for registro in registros %}
                                        <tr class="border-b border-gray-light dark:border-gray-700">
                                            <td class="px-6 py-4">{{ registro.funcionario }}</td>
                                            <td class="px-6 py-4">{{ registro.projeto }}</td>
                                            <td class="px-6 py-4 text-center">{{ registro.data }}</td>
                                            <td class="px-6 py-4 text-center">{{ registro.horas_trabalhadas }}</td>
                                            <td class="px-6 py-4 text-center">
                                                <a href="{{ url_for('registros.editar', id=registro.id) }}" class="p-2 text-primary hover:text-primary/80">
                                                    <span class="material-symbols-outlined text-xl">edit</span>
                                                </a>
                                                <form action="{{ url_for('registros.remover', id=registro.id) }}" method="POST" class="d-inline">
                                                    <button type="submit" class="p-2 text-error hover:text-error/80">
                                                        <span class="material-symbols-outlined text-xl">delete</span>
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-info bg-gray-100 dark:bg-background-dark/60">
                                        <td class="px-6 py-4 font-black" colspan="3">Total de Horas:</td>
                                        <td class="px-6 py-4 font-black text-center">{{ total_horas | formatar_horas }}</td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                            <div class="flex justify-between items-center p-4">
                                <ul class="flex gap-2 justify-center">
                                    {% if pagina > 1 %}
                                    <li>
                                        <a href="?{{ query_string_pages }}&pagina={{ pagina - 1 }}" class="btn btn-secondary">Anterior</a>
                                    </li>
                                    {% endif %}

                                    {% for p in range(1, total_paginas + 1) %}
                                    <li>
                                        <a href="?{{ query_string_pages }}&pagina={{ p }}"
                                        class="btn {% if p == pagina %}btn-primary{% else %}btn-outline{% endif %}">
                                        {{ p }}
                                        </a>
                                    </li>
                                    {% endfor %}

                                    {% if pagina < total_paginas %}
                                    <li>
                                        <a href="?{{ query_string_pages }}&pagina={{ pagina + 1 }}" class="btn btn-secondary">Próxima</a>
                                    </li>
                                    {% endif %}
                                </ul>
                                <form method="GET" id="form_pages" class="flex items-center gap-4">
                                    <!-- Mantém os filtros atuais -->
                                    {% for k, v in request.args.items() %}
                                        {% if k != 'registros_por_pagina' and k != 'pagina' %}
                                            <input type="hidden" name="{{ k }}" value="{{ v }}">
                                        {% endif %}
                                    {% endfor %}

                                    <label for="registros_por_pagina" class=" w-full text-sm font-medium">Registros por página:</label>
                                    <select name="registros_por_pagina" id="registros_por_pagina" onchange="this.form.submit()" class="form-select flex w-full min-w-0 resize-none overflow-hidden rounded-lg text-text-primary dark:text-white focus:outline-0 focus:ring-2 focus:ring-primary/50 border-gray-medium/50 dark:border-gray-700 bg-white dark:bg-background-dark h-14 placeholder:text-gray-medium p-[15px] text-base font-normal leading-normal cursor-pointer">
                                        <option value="5" {% if registros_por_pagina == 5 %}selected{% endif %}>5</option>
                                        <option value="10" {% if registros_por_pagina == 10 %}selected{% endif %}>10</option>
                                        <option value="20" {% if registros_por_pagina == 20 %}selected{% endif %}>20</option>
                                        <option value="50" {% if registros_por_pagina == 50 %}selected{% endif %}>50</option>
                                    </select>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
    {% endblock %}
    {% block script %}
        <!-- jQuery e JS do Select2 -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>
            $(document).ready(function() {
                $('#funcionario_id').select2({
                    placeholder: "Selecione ou pesquise um colaborador",
                    allowClear: true,
                    width: '100%'
                });
            });
        </script>
        
        <script>
            $(document).ready(function() {
                $('#projeto_id').select2({
                    placeholder: "Selecione ou pesquise um projeto",
                    allowClear: true,
                    width: '100%'
                });
            });
        </script>

        <script>
            const dataInput = document.getElementById("data");

            dataInput.addEventListener("click", () => {
                dataInput.showPicker(); // força abrir o seletor
            });
        </script>
    {% endblock %}