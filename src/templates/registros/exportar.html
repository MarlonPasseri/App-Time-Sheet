{% extends 'base.html' %}
    {% block head %}
        <!-- CSS do Select2 -->
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
        <style>
            /* Container principal do select 2 */
            .select2-container .select2-selection--multiple {
                height: 3.5rem !important;
                padding: 0 !important;
                padding-left: 16px !important;
                border-radius: 0.5rem; /* rounded-lg */
                border: 1px solid #dbe2e6; /* sua classe border-gray-medium */
                background-color: white;

                position: relative;
                padding-right: 2rem !important; /* espaço para a seta */

                *{
                    margin: 0 !important;
                }
                :hover{
                    background-color: transparent !important;
                }
            }

            /* seta estilizada com CSS */
            .select2-container--default .select2-selection--multiple::after {
                content: "▾"; /* seta para baixo */
                position: absolute;
                right: 12px;
                top: 50%;
                transform: translateY(-50%);
                font-size: 1.3rem;
                color: #6b7280; /* cinza */
                pointer-events: none; /* não bloquear clique */
            }

            .dark .select2-container .select2-selection--multiple {
                background-color: #1f2937 !important; /* dark:bg-gray-700 */
                border-color: #374151 !important;     /* dark:border-gray-600 */
                color: white !important;
            }

            /* Container de pesquisa */
            .select2-search--inline .select2-search__field {
                height: 3.5rem !important;
                line-height: 3.5rem !important;
                font-family: inherit !important;
            }

            /* Container de seleção de opção */
            .select2-selection__choice{
                line-height: 3.5rem !important;
                background-color: transparent !important;
                border: none !important;
            }

            /* Container de remoção de opção */
            .select2-selection__choice__remove{
                color: #ff0000 !important;
                font-weight: 900 !important;
                font-size: 20px !important;
                border: none !important;
            }
        </style>

    {% endblock %}
    {% block main %}
            <main class="px-10 md:px-20 lg:px-40 flex flex-1 justify-center py-5">
                <div class="layout-content-container flex flex-col max-w-7xl flex-1">
                    <div class="flex flex-wrap justify-between gap-3 p-4">
                        <div class="flex min-w-72 flex-col gap-3">
                        <p class="text-[#111618] dark:text-white text-4xl font-black leading-tight tracking-[-0.033em]">Relatório de Horas</p>
                        <p class="text-[#617c89] dark:text-gray-400 text-base font-normal leading-normal">Gere relatórios detalhados sobre as horas trabalhadas por projeto.</p>
                        </div>
                    </div>
                    <form method="POST" action="{{ url_for('registros.exportar_excel') }}" id="exportForm">
                        <div class="bg-white dark:bg-gray-800 border border-[#dbe2e6] dark:border-gray-700 rounded-xl shadow-sm p-5 flex flex-col gap-6">
                            <!-- Filtros -->
                            <div class="flex flex-col gap-4">
                                <h2 class="text-[#111618] dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">
                                    Filtros
                                </h2>

                                <div class="grid grid-cols-1 {% if admin_check %} md:grid-cols-3 {% else %} md:grid-cols-2 {% endif %} gap-4">
                                    {% if admin_check %}
                                    <label for="funcionario_id" class="flex flex-col min-w-40 flex-1">
                                        <p class="text-[#111618] dark:text-gray-300 text-sm font-medium leading-normal pb-2">Colaborador</p>
                                        <select id="funcionario_id" name="funcionario_id" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111618] dark:text-white dark:bg-gray-800 focus:outline-0 focus:ring-0 border border-[#dbe2e6] dark:border-gray-700 bg-white focus:border-primary h-14 p-[15px] text-base font-normal leading-normal" multiple>
                                            <option value="">Todos</option>
                                            {% for funcionario in funcionarios %}
                                                <option value="{{ funcionario.id }}">{{ funcionario.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                    {% else %}
                                    <input type="hidden" name="funcionario_id" value="{{ funcionario_logado }}">
                                    {% endif %}

                                    <label for="projeto_id" class="flex flex-col min-w-40 flex-1">
                                        <p class="text-[#111618] dark:text-gray-300 text-sm font-medium leading-normal pb-2">Contrato</p>
                                        <select id="projeto_id" name="projeto_id" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111618] dark:text-white dark:bg-gray-800 focus:outline-0 focus:ring-0 border border-[#dbe2e6] dark:border-gray-700 bg-white focus:border-primary h-14 p-[15px] text-base font-normal leading-normal" multiple>
                                            <option value="">Todos</option>
                                            {% for projeto in projetos %}
                                                <option value="{{ projeto.id }}">{{ projeto.cod }} | {{ projeto.nome }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>

                                    <label for="mes_ano" class="flex flex-col min-w-40 flex-1">
                                        <p class="text-[#111618] dark:text-gray-300 text-sm font-medium leading-normal pb-2">Data</p>
                                        <select id="mes_ano" name="mes_ano" class="form-select flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-lg text-[#111618] dark:text-white dark:bg-gray-800 focus:outline-0 focus:ring-0 border border-[#dbe2e6] dark:border-gray-700 bg-white focus:border-primary h-14 p-[15px] text-base font-normal leading-normal" multiple>
                                            <option value="">Todos</option>
                                            {% for mes_ano in meses_anos %}
                                                {% set partes = mes_ano.split('-') %}
                                                <option value="{{ partes[1] }}-{{ partes[0] }}">
                                                    {{ mes_ano }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                </div>
                            </div>

                            <!-- Tipo de relatório em botões “cards” -->
                            <div class="flex flex-col gap-3">
                                <p class="text-[#111618] dark:text-gray-200 text-sm font-medium leading-normal">Tipo de Relatório</p>
                                
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                    <!-- Padrão -->
                                    <div>
                                        <input class="peer hidden" type="radio" name="tipo_relatorio" id="tipo_padrao" value="padrao" checked>
                                        <label for="tipo_padrao" class="flex items-center gap-2 w-full cursor-pointer rounded-lg border border-[#dbe2e6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-3 py-3 text-sm text-[#111618] dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition transform duration-150 peer-checked:border-primary peer-checked:text-white peer-checked:bg-primary peer-checked:scale-[1.02] peer-checked:shadow">
                                            <i class="bi bi-list-ul"></i>
                                            <span>Padrão (Lista simples)</span>
                                        </label>
                                    </div>

                                    <!-- Por Funcionário -->
                                    <div>
                                        <input class="peer hidden" type="radio" name="tipo_relatorio" id="tipo_funcionario" value="por_funcionario">
                                        <label for="tipo_funcionario" class="flex items-center gap-2 w-full cursor-pointer rounded-lg border border-[#dbe2e6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-3 py-3 text-sm text-[#111618] dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition transform duration-150 peer-checked:border-primary peer-checked:text-white peer-checked:bg-primary peer-checked:scale-[1.02] peer-checked:shadow">
                                            <i class="bi bi-person"></i>
                                            <span>Por Funcionário</span>
                                        </label>
                                    </div>

                                    <!-- Por Projeto -->
                                    <div>
                                        <input class="peer hidden" type="radio" name="tipo_relatorio" id="tipo_projeto" value="por_projeto">
                                        <label for="tipo_projeto" class="flex items-center gap-2 w-full cursor-pointer rounded-lg border border-[#dbe2e6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-3 py-3 text-sm text-[#111618] dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition transform duration-150 peer-checked:border-primary peer-checked:text-white peer-checked:bg-primary peer-checked:scale-[1.02] peer-checked:shadow">
                                            <i class="bi bi-briefcase"></i>
                                            <span>Por Projeto</span>
                                        </label>
                                    </div>

                                    <!-- Mensal -->
                                    <div>
                                        <input class="peer hidden" type="radio" name="tipo_relatorio" id="tipo_mensal" value="mensal">
                                        <label for="tipo_mensal" class="flex items-center gap-2 w-full cursor-pointer rounded-lg border border-[#dbe2e6] dark:border-gray-700 bg-gray-50 dark:bg-gray-800 px-3 py-3 text-sm text-[#111618] dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition transform duration-150 peer-checked:border-primary peer-checked:text-white peer-checked:bg-primary peer-checked:scale-[1.02] peer-checked:shadow">
                                            <i class="bi bi-grid-3x3"></i>
                                            <span>Mensal (Matriz)</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- Personalizado em destaque full-width -->
                                <div>
                                    <input class="peer hidden" type="radio" name="tipo_relatorio" id="tipo_personalizado" value="personalizado">
                                    <label for="tipo_personalizado" class="flex items-center gap-3 w-full cursor-pointer rounded-lg border border-emerald-500/60 bg-emerald-50 dark:bg-emerald-900/20 px-3 py-3 text-sm text-emerald-800 dark:text-emerald-200 hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition transform duration-150 peer-checked:border-emerald-600 peer-checked:text-white peer-checked:bg-emerald-400 peer-checked:scale-[1.02] peer-checked:shadow">
                                        <span class="inline-flex items-center rounded-full bg-emerald-500 px-2 py-0.5 text-[11px] font-semibold text-white uppercase tracking-wide">
                                            Novo
                                        </span>
                                        <i class="bi bi-file-earmark-spreadsheet"></i>
                                        <span>Formato Personalizado (Template)</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Botão -->
                            <div class="flex justify-end gap-3 mt-2">
                                <button type="submit" id="btnExportar" class="flex items-center gap-2 min-w-[84px] max-w-[480px] cursor-pointer justify-center overflow-hidden rounded-lg h-10 px-4 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em]">
                                    <span class="material-symbols-outlined">description</span>
                                    <span class="truncate">Gerar Relatório</span>
                                </button>
                            </div>
                        </div>
                    </form>

                    <div class="mt-6">
                        <h2 class="text-[#111618] dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em] p-4 pt-0">
                            Detalhes dos Tipos de Relatório
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Padrão -->
                            <div class="bg-white dark:bg-gray-800 border border-[#dbe2e6] dark:border-gray-700 rounded-xl shadow-sm p-4 flex flex-col gap-2">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-list-ul text-primary"></i>
                                    <p class="text-sm font-semibold text-[#111618] dark:text-gray-100">Relatório Padrão</p>
                                </div>
                                <p class="text-sm text-[#617c89] dark:text-gray-400">
                                    Lista simples de todos os registros com colunas para Funcionário, Projeto, Data e Horas Trabalhadas. Inclui uma linha de total ao final.
                                </p>
                            </div>

                            <!-- Por Funcionário -->
                            <div class="bg-white dark:bg-gray-800 border border-[#dbe2e6] dark:border-gray-700 rounded-xl shadow-sm p-4 flex flex-col gap-2">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-person text-primary"></i>
                                    <p class="text-sm font-semibold text-[#111618] dark:text-gray-100">Relatório por Funcionário</p>
                                </div>
                                <p class="text-sm text-[#617c89] dark:text-gray-400">
                                    Cria uma planilha separada para cada funcionário, listando todos os seus registros. Inclui uma planilha de resumo com o total de horas por funcionário.
                                </p>
                            </div>

                            <!-- Por Projeto -->
                            <div class="bg-white dark:bg-gray-800 border border-[#dbe2e6] dark:border-gray-700 rounded-xl shadow-sm p-4 flex flex-col gap-2">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-briefcase text-primary"></i>
                                    <p class="text-sm font-semibold text-[#111618] dark:text-gray-100">Relatório por Projeto</p>
                                </div>
                                <p class="text-sm text-[#617c89] dark:text-gray-400">
                                    Cria uma planilha separada para cada projeto, listando todos os registros relacionados. Inclui uma planilha de resumo com o total de horas por projeto.
                                </p>
                            </div>

                            <!-- Mensal -->
                            <div class="bg-white dark:bg-gray-800 border border-[#dbe2e6] dark:border-gray-700 rounded-xl shadow-sm p-4 flex flex-col gap-2">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-grid-3x3 text-primary"></i>
                                    <p class="text-sm font-semibold text-[#111618] dark:text-gray-100">Relatório Mensal</p>
                                </div>
                                <p class="text-sm text-[#617c89] dark:text-gray-400">
                                    Cria uma matriz com funcionários nas linhas e projetos nas colunas, mostrando o total de horas para cada combinação. Inclui totais por funcionário e por projeto.
                                </p>
                            </div>

                            <!-- Personalizado -->
                            <div class="bg-white dark:bg-gray-800 border border-emerald-500/70 rounded-xl shadow-sm p-4 flex flex-col gap-3 md:col-span-2">
                                <div class="flex items-center gap-2">
                                    <i class="bi bi-file-earmark-spreadsheet text-emerald-600"></i>
                                    <p class="text-sm font-semibold text-[#111618] dark:text-gray-100">Formato Personalizado (Template)</p>
                                </div>
                                <p class="text-sm text-[#617c89] dark:text-gray-400">
                                    Gera um relatório seguindo exatamente o formato do template fornecido, com cabeçalhos, formatação e estrutura específicos. Ideal para integração com outros sistemas e processos da empresa.
                                </p>
                                <div class="flex items-start gap-2 rounded-lg border border-emerald-100 dark:border-emerald-900 bg-emerald-50/70 dark:bg-emerald-900/20 px-3 py-2">
                                    <i class="bi bi-info-circle-fill text-emerald-600 mt-[2px]"></i>
                                    <p class="text-xs text-emerald-800 dark:text-emerald-200">
                                        <strong>Nota:</strong> Este formato é especialmente projetado para atender aos requisitos específicos de relatórios da empresa.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
        </main>
    {% endblock %}
    {% block script %}
        <script>
            // Script para alterar a ação do formulário com base no tipo de relatório selecionado
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('exportForm');
                const tipoPersonalizado = document.getElementById('tipo_personalizado');

                // Action padrão (relatórios normais)
                const defaultAction = "{{ url_for('registros.exportar_excel') }}";
                const personalizadoAction = "{{ url_for('registros.exportar_personalizado') }}";

                form.addEventListener('submit', function (e) {
                    // Se for personalizado, manda pra rota personalizada
                    if (tipoPersonalizado.checked) {
                        form.action = personalizadoAction;
                    } else {
                        // Qualquer outro tipo volta pra rota padrão
                        form.action = defaultAction;
                    }
                    // Não precisa de preventDefault nem de form.submit() manual
                });
            });
        </script>

        <!-- jQuery e JS do Select2 -->
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

        <!-- Configurações padrões -->
        <script>
            regrasSelect2Colaborador = {
                placeholder: "Todos",
                width: '100%',
                maximumSelectionLength: 1,   // limita a 1 item
                language: {
                    maximumSelected: function () {
                        return "Você só pode selecionar um item.";
                    },
                    noResults: function () {
                        return "Nenhum colaborador encontrado";
                    }
                }
            };

            regrasSelect2Contrato = {
                placeholder: "Todos",
                width: '100%',
                maximumSelectionLength: 1,   // limita a 1 item
                language: {
                    maximumSelected: function () {
                        return "Você só pode selecionar um item.";
                    },
                    noResults: function () {
                        return "Nenhum contrato encontrado";
                    }
                }
            };

            regrasSelect2Data = {
                placeholder: "Todas",
                width: '100%',
                maximumSelectionLength: 1,   // limita a 1 item
                language: {
                    maximumSelected: function () {
                        return "Você só pode selecionar um item.";
                    },
                    noResults: function () {
                        return "Nenhuma data encontrada";
                    }
                }
            };

            
        </script>

        <script>
            $(document).ready(function() {
                $('#funcionario_id').select2(regrasSelect2Colaborador);
                $('#projeto_id').select2(regrasSelect2Contrato);
                $('#mes_ano').select2(regrasSelect2Data);
            });
        </script>

    {% endblock %}