{% extends 'base.html' %}

    {% block main %}
        <!-- HeadlineText -->
        <h1 class="text-text-primary dark:text-white tracking-light text-[32px] font-bold leading-tight">Dashboard</h1>
        <p class="text-gray-500 dark:text-gray-400 mt-1 mb-6">Bem-vindo de volta, {{ usuario.nome }}! Aqui está um resumo da sua semana.</p>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column -->
            <div class="lg:col-span-2 flex flex-col gap-6">
                <!-- SectionHeader -->
                <h2 class="text-text-primary dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Fique por Dentro</h2>
                <!-- Carousel -->
                <div class="flex overflow-x-auto gap-6 pb-4 snap-x snap-mandatory scrollbar-hide">
                    <div class="flex-shrink-0 w-72 flex flex-col gap-4 rounded-lg bg-white dark:bg-gray-800 shadow-md snap-start">
                        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-t-lg" data-alt="An abstract image representing a new health plan benefit." style='background-image: url("https://wallpapers.com/images/hd/balloons-background-x2f7uvp2r5342vn7.jpg");'></div>
                        <div class="flex flex-col flex-1 justify-between p-4 pt-0 gap-4">
                            <div>
                                <p class="text-text-primary dark:text-white text-base font-semibold">40 anos de Geoprojetos</p>
                                <p class="text-gray-500 dark:text-gray-400 text-sm font-normal">Como foi o evento de aniversário da empresa.</p>
                            </div>
                            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-md h-10 px-4 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-300 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
                                <span class="truncate">Ler mais</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72 flex flex-col gap-4 rounded-lg bg-white dark:bg-gray-800 shadow-md snap-start">
                        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-t-lg" data-alt="An abstract image showing system update visuals." style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuDvqLcvbc52Wi0aXyCN66WhdLwdSWimFaf835tQTjEHKn4RG16NYDAoZOwWIeaCn7B0HUnWPOqBqZiGw4Jcc0WK4co3nR_yj2tRpdzlLwRQlrLdp9I5ejORsEFEUmkPdCny638_trcVhNLlTM_MivByb4ZARW9dXoDUSa0UOdbwOC4vyHkAjRbkDEfJbxUajAo-RvLFKrdPL4mAQpIWSV950f08Ci9UCzHy2RqSvnune6R2iOpFWBfOazFEIEZmDXdvgVzHKyXz2L8");'></div>
                        <div class="flex flex-col flex-1 justify-between p-4 pt-0 gap-4">
                            <div>
                                <p class="text-text-primary dark:text-white text-base font-semibold">Atualização no sistema X</p>
                                <p class="text-gray-500 dark:text-gray-400 text-sm font-normal">Confira as novidades da última atualização.</p>
                            </div>
                            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-md h-10 px-4 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-300 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
                                <span class="truncate">Ler mais</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72 flex flex-col gap-4 rounded-lg bg-white dark:bg-gray-800 shadow-md snap-start">
                        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-t-lg" data-alt="A festive image from the end-of-year party." style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuBAIk5Uu4dKvQGGYl7oLZjVAZKRLIdFGCqoxz0_VJ2PFcr-RqY_TD0gGHRewCp8ajDMWfzoqNBkf6-kbUhXdGemGfh3LFhVi_w2kwjWL1wVavoc_bS0RCuHDiTqHF6qWqaRPM2Nd4kF-uIQWE9NzuynIR77zDtJoCj013qnC6P7IotZmNCv1x9eRFR7SHddTCgeSdrq_4P_2NaeJqsNx8uFKoHnIuOv-_pg2BAts2bt6DJlyXQhjPxX2INWb3Ag-xDACCTIWEKU3Oc");'></div>
                        <div class="flex flex-col flex-1 justify-between p-4 pt-0 gap-4">
                            <div>
                                <p class="text-text-primary dark:text-white text-base font-semibold">Confraternização de fim de ano</p>
                                <p class="text-gray-500 dark:text-gray-400 text-sm font-normal">Veja as fotos da nossa festa de fim de ano.</p>
                            </div>
                            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-md h-10 px-4 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-300 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
                                <span class="truncate">Ler mais</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex-shrink-0 w-72 flex flex-col gap-4 rounded-lg bg-white dark:bg-gray-800 shadow-md snap-start">
                        <div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-t-lg" data-alt="An abstract image representing a new health plan benefit." style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAVRG-X58HdkxVQEZM8J4xZHvA8MBWCgXQFyZV_yS6a2hblL_YR9o4iOx_hUY4-R-jllnSBapvsSyACxx_OXJeUXlWVtjG06wmK3Yuo4RH9Iph9VMn6NtCUDh_sWdpp5NAZt-nJ5bmahPgSPp2aX99N0Zs-DTIbxQanvN9x6X7b9P57SVD1BSe75KXHkRxcymhGWKXG4ph7M6yuZzCJdSvasOBY2lwWesGS77F3SZ9DJ8PK6peuFo_gb19KiUAvH0ULj1RZAZTWXJE");'></div>
                        <div class="flex flex-col flex-1 justify-between p-4 pt-0 gap-4">
                            <div>
                                <p class="text-text-primary dark:text-white text-base font-semibold">Novo benefício para funcionários</p>
                                <p class="text-gray-500 dark:text-gray-400 text-sm font-normal">Saiba mais sobre o novo plano de saúde.</p>
                            </div>
                            <button class="flex w-full cursor-pointer items-center justify-center overflow-hidden rounded-md h-10 px-4 bg-primary/10 text-primary dark:bg-primary/20 dark:text-primary-300 text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary/20 dark:hover:bg-primary/30 transition-colors">
                                <span class="truncate">Ler mais</span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- SectionHeader -->
                <h2 class="text-text-primary dark:text-white text-[22px] font-bold leading-tight tracking-[-0.015em]">Sua Semana em Números</h2>
                <!-- === Charts Section === -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg p-6 pb-1">Horas por Contrato</h3>
                        <div id="grafico-horas"></div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg p-6 pb-1">Evolução das Horas no Mês</h3>
                        <div id="grafico-hora-mes"></div>
                    </div>
                </div>
            </div>
            <!-- Right Column -->
            <div class="lg:col-span-1">
                <div class="flex flex-col gap-6">
                    <!-- Quick Actions -->
                    <div class="flex flex-col gap-4">
                        <a class="flex w-full items-center justify-center gap-2 rounded-lg h-12 px-6 bg-primary text-white text-base font-bold hover:bg-primary/90 transition-colors shadow-md" href="{{ url_for('registros.listar') }}">
                            <span class="material-symbols-outlined">add_circle</span>
                            <span>Registrar Minhas Horas</span>
                        </a>
                        <a class="flex w-full items-center justify-center gap-2 rounded-lg h-12 px-6 bg-gray-200 dark:bg-gray-700 text-text-primary dark:text-white text-base font-bold hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors shadow-md" href="{{ url_for('registros.exportar') }}">
                            <span class="material-symbols-outlined">picture_as_pdf</span>
                            <span>Ver Meus Relatórios</span>
                        </a>
                    </div>
                    <!-- Weekly Hours Summary -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md flex items-center justify-between">
                        <div>
                            <h3 class="font-semibold text-lg text-gray-500 dark:text-gray-400">Total de Horas <strong>{{nome_mes_atual}}</strong></h3>
                            <p class="text-4xl font-bold text-primary mt-1">{{ total_horas_mes }} / 744 h</p>
                        </div>
                        <div class="w-20 h-20 flex items-center justify-center rounded-full bg-accent-success/10 text-accent-success">
                            <span class="material-symbols-outlined" style="font-size: 48px;">check_circle</span>
                        </div>
                    </div>
                    <!-- Projects in Progress -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Projetos em Andamento</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between mb-1">
                                    <p class="font-medium">Sistema de Gestão Interna</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">75%</p>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-primary h-2.5 rounded-full" style="width: 75%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <p class="font-medium">App Mobile Vendas</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">40%</p>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-accent-warning h-2.5 rounded-full" style="width: 40%"></div>
                                </div>
                            </div>
                            <div>
                                <div class="flex justify-between mb-1">
                                    <p class="font-medium">Dashboard de BI</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">90%</p>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                    <div class="bg-accent-success h-2.5 rounded-full" style="width: 90%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endblock %}

    {% block script %}
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
        <script>
            var noDataMock = "<p class='p-6'>Nenhum dado disponível.</p>";
            (function() {
                // == Gráfico de Pizza: Horas por Projeto ==
                let projetosGrafico = {{ projetos|tojson|safe }};

                const labelsCod = projetosGrafico.map(p => p.split("-")[0]);
                const nomesProjetos = projetosGrafico.map(p => p.split("-")[1]); 


                let horasProjetoGrafico = {{ horas|tojson|safe }};

                if (!projetosGrafico || projetosGrafico.length === 0) {
                    document.getElementById('grafico-horas').innerHTML = noDataMock;
                    return;
                }

                const dataProjetos = {
                    labels: labelsCod,   // cada fatia representa um projeto
                    values: horasProjetoGrafico,      // valores correspondentes às horas
                    type: 'pie',
                    text: horasProjetoGrafico.map(h => h + 'h'),
                    textinfo: 'label+text',
                    hoverinfo: 'text',

                    hovertemplate:
                        // "<b>Cod:</b> %{label}<br>" +
                        "<b>Nome:</b> %{customdata}<br>" +
                        "<b>Horas:</b> %{value}h<br>" +
                        "<b>Percentual:</b> %{percent}<extra></extra>",

                    customdata: nomesProjetos, // usado no hover
                    textposition: 'inside', // 'inside', 'outside' ou 'auto'

                    marker: {
                        colors: ['#636EFA', '#EF553B', '#00CC96', '#AB63FA', '#FFA15A', '#19D3F3', '#FF6692', '#B6E880'],
                        line: {
                            color: '#FFFFFF',
                            width: 1
                        }
                    }
                };

                const layoutProjetos = {
                    margin: { t: 15, b: 5, l: 5, r: 5},
                    // paper_bgcolor: '#f5f5f5',  // fundo total do gráfico (incluindo bordas)
                    // plot_bgcolor: '#000000', // fundo da plotagem
                    showlegend: false,
                    hovermode: 'closest', // ou 'x' / 'y'
                    // hoverdistance: 5, // distância em pixels para ativar o hover
                };

                Plotly.newPlot('grafico-horas', [dataProjetos], layoutProjetos, {responsive: true});
            })();
            (function() {
                    // == Gráfico de Linhas: Evolução das Horas no Mês ==
                    let MesesGrafico = {{ meses|tojson|safe }};
                    let horasMesesGrafico = {{ horas_mensais|tojson|safe }};

                    if (!horasMesesGrafico || horasMesesGrafico.length === 0) {
                        document.getElementById('grafico-hora-mes').innerHTML = noDataMock;
                        return;
                    }

                let dataMeses = {
                    x: MesesGrafico,
                    y: horasMesesGrafico,
                    type: 'bar',
                    text: horasMesesGrafico.map(h => h.toFixed(2) + 'h'),
                    hoverinfo: 'text',
                    // textposition: 'outside',
                    marker: { 
                        color: '#0185b8',
                        line: { color: '#005593', width: 1 }
                    },
                };

                const layoutMeses = {
                    // title: 'Horas Trabalhadas por Projeto',
                    // xaxis: { title: 'Meses' },
                    // yaxis: { title: 'Horas Trabalhadas' },
                    margin: { t: 50, b: 100 }
                };

                Plotly.newPlot('grafico-hora-mes', [dataMeses], layoutMeses, {responsive: true});

            })();
        </script>
    {% endblock %}